<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NingGuru Drive Pro</title>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <script src="https://unpkg.com/@element-plus/icons-vue"></script>
    
    <style>
        :root {
            --app-bg-url: none;
            --app-bg-fallback: #f0f0f0;
            --app-content-overlay: rgba(0, 0, 0, 0.1); 
            --app-text: #fff; 
            --app-text-shadow: 0 1px 3px rgba(0,0,0,0.9); 
            --app-accent: #409eff;
            --app-header-border: rgba(255,255,255,0.1);
            --app-logo-gradient: #fff;
            --el-color-primary: var(--app-accent);
        }
        * { touch-action: manipulation; box-sizing: border-box; }
        body { 
            margin: 0; height: 100%; font-family: 'PingFang SC', sans-serif; 
            background-color: #333;
            background-image: var(--app-bg-url), var(--app-bg-fallback);
            background-size: cover; background-position: center; background-attachment: fixed;
            color: var(--app-text); transition: background 0.5s ease;
        }
        #app { height: 100vh; display: flex; flex-direction: column; }
        .el-header { background: rgba(0,0,0,0.3); border-bottom: 1px solid var(--app-header-border); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 100; }
        .logo { font-size: 24px; font-weight: 900; color: #fff; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }
        .el-main { background: var(--app-content-overlay); margin: 20px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.15); padding: 20px; overflow-x: hidden; flex: 1; }
        .el-table, .el-table th, .el-table td, .el-table tr { background-color: transparent !important; border-bottom-color: rgba(255,255,255,0.1) !important; color: var(--app-text) !important; text-shadow: var(--app-text-shadow); font-weight: 600; }
        .el-table--enable-row-hover .el-table__body tr:hover > td { background-color: rgba(255,255,255,0.2) !important; border-radius: 8px; }
        @media (max-width: 768px) { .el-header { height: auto !important; flex-wrap: wrap; gap: 10px; padding: 10px; } .logo span { display: none; } .el-main { margin: 5px; padding: 10px; } .header-right { width: 100%; justify-content: flex-end; } }
        /* éšç§æ¨¡å¼ä¸‹çš„çº¢è‰²ä¸»é¢˜ */
        .private-mode-badge { background: #f56c6c; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; margin-left: 10px; vertical-align: middle; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
    </style>
</head>
<body>
    <div id="app">
        <el-header height="70px">
            <div class="logo">NINGGURU <span style="font-size: 14px; opacity: 0.8; font-weight: normal;">Gift Edition</span>
                <span v-if="isPrivateMode" class="private-mode-badge">ğŸ”’ éšç§ç©ºé—´</span>
            </div>
            
            <div class="header-right" style="display: flex; gap: 10px; align-items: center;">
                <el-button v-if="!isPrivateMode" type="danger" plain round size="default" @click="enterPrivateMode">
                    <el-icon><Lock /></el-icon> éšç§ç©ºé—´
                </el-button>
                <el-button v-else type="info" plain round size="default" @click="exitPrivateMode">
                    <el-icon><Unlock /></el-icon> è¿”å›å…¬å¼€
                </el-button>

                <el-dropdown @command="handleThemeChange" trigger="click">
                    <el-button circle size="default" color="rgba(255,255,255,0.2)" style="color: white; border: 1px solid rgba(255,255,255,0.5);">
                        <el-icon><Magic-Stick /></el-icon>
                    </el-button>
                    <template #dropdown>
                        <el-dropdown-menu>
                            <el-dropdown-item command="doraemon">ğŸ”µ å“†å•¦Aæ¢¦</el-dropdown-item>
                            <el-dropdown-item command="pink">ğŸŒ¸ ä½³ä½³çš„ç²‰è‰²</el-dropdown-item>
                            <el-dropdown-item command="spongebob">ğŸŸ¡ æµ·ç»µå®å®</el-dropdown-item>
                            <el-dropdown-item command="zootopia">ğŸ¦Š ç–¯ç‹‚åŠ¨ç‰©åŸ</el-dropdown-item>
                            <el-dropdown-item command="shinchan">ğŸ–ï¸ èœ¡ç¬”å°æ–°</el-dropdown-item>
                            <el-dropdown-item command="dark" divided>âš« æå®¢é»‘</el-dropdown-item>
                        </el-dropdown-menu>
                    </template>
                </el-dropdown>

                <div style="display: flex; gap: 8px;">
                    <el-button type="primary" :icon="Upload" @click="triggerUpload" round>ä¸Šä¼ </el-button>
                    <el-button type="success" plain @click="createFolderDialog = true" :icon="FolderAdd" circle></el-button>
                     <el-button type="danger" plain v-if="selection.length > 0" @click="batchDelete" :icon="Delete" circle></el-button>
                    <input type="file" ref="fileInput" style="display: none" @change="handleUpload">
                </div>
            </div>
        </el-header>

        <el-main>
            <el-breadcrumb separator=">" style="margin-bottom: 20px; font-size: 16px;">
                <el-breadcrumb-item><a @click="navigate('')" style="cursor: pointer; font-weight: 900; color: #fff; text-shadow: 0 1px 3px rgba(0,0,0,0.8);">ğŸ  é¦–é¡µ</a></el-breadcrumb-item>
                <el-breadcrumb-item v-for="(crumb, index) in breadcrumbs" :key="index">
                    <a @click="navigate(crumb.path)" style="cursor: pointer; font-weight: bold;">{{ crumb.name }}</a>
                </el-breadcrumb-item>
            </el-breadcrumb>

            <el-table :data="tableData" style="width: 100%" @selection-change="handleSelectionChange" v-loading="loading">
                <el-table-column type="selection" width="40"></el-table-column>
                <el-table-column label="åç§°" min-width="200">
                    <template #default="scope">
                        <div style="display: flex; align-items: center; cursor: pointer;" @click="handleRowClick(scope.row)">
                            <el-icon v-if="scope.row.isDir" size="24" color="#ffca28" style="margin-right: 10px; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.6));"><Folder /></el-icon>
                            <el-icon v-else-if="scope.row.type === 'image'" size="24" color="#409eff" style="margin-right: 10px;"><Picture /></el-icon>
                            <el-icon v-else-if="scope.row.type === 'video'" size="24" color="#f56c6c" style="margin-right: 10px;"><Video-Play /></el-icon>
                            <el-icon v-else size="24" color="#ddd" style="margin-right: 10px;"><Document /></el-icon>
                            <span>{{ scope.row.name }}</span>
                        </div>
                    </template>
                </el-table-column>
                <el-table-column v-if="!isMobile" prop="size" label="å¤§å°" width="100"></el-table-column>
                <el-table-column v-if="!isMobile" prop="last_modified" label="æ—¶é—´" width="180"></el-table-column>
                <el-table-column label="æ“ä½œ" width="80" align="center" fixed="right">
                    <template #default="scope">
                        <el-button v-if="!scope.row.isDir" link type="primary" :icon="Download" @click.stop="window.open(scope.row.url)" style="color: #fff; font-weight: bold;"></el-button>
                    </template>
                </el-table-column>
            </el-table>
        </el-main>

        <el-dialog v-model="loginDialog" title="NingGuru Cloud" width="300px" :close-on-click-modal="false" :close-on-press-escape="false" :show-close="false" center>
            <el-input v-model="passwordInput" type="password" placeholder="è¯·è¾“å…¥è®¿é—®å¯†ç " show-password @keyup.enter="doLogin"></el-input>
            <template #footer><el-button type="primary" @click="doLogin" style="width: 100%">è¿›å…¥ç³»ç»Ÿ</el-button></template>
        </el-dialog>

        <el-dialog v-model="privateDialog" title="ğŸ”’ è§£é”éšç§ç©ºé—´" width="300px" center>
            <el-input v-model="privatePasswordInput" type="password" placeholder="è¯·è¾“å…¥éšç§å¯†ç " show-password @keyup.enter="doUnlockPrivate"></el-input>
            <template #footer><el-button type="danger" @click="doUnlockPrivate" style="width: 100%">è§£é”</el-button></template>
        </el-dialog>

        <el-dialog v-model="videoDialog" title="é¢„è§ˆ" width="90%" destroy-on-close center style="background: #000;">
            <div style="display:flex; justify-content:center;"><video :src="currentVideoUrl" controls autoplay style="max-width:100%; max-height:80vh;"></video></div>
        </el-dialog>
        <el-dialog v-model="createFolderDialog" title="æ–°å»ºæ–‡ä»¶å¤¹" width="80%">
            <el-input v-model="newFolderName" placeholder="åç§°"></el-input>
            <template #footer>
                <el-button @click="createFolderDialog = false">å–æ¶ˆ</el-button>
                <el-button type="primary" @click="doCreateFolder">ç¡®å®š</el-button>
            </template>
        </el-dialog>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;
        const { ElMessage } = ElementPlus;
        const { Folder, Document, Picture, VideoPlay, Upload, Download, FolderAdd, Delete, MagicStick, Lock, Unlock } = ElementPlusIconsVue;

        const themeConfig = {
            doraemon: { img: 'bg/doraemon.jpg', gradient: 'linear-gradient(135deg, #0096fa, #fff)', overlay: 'rgba(0,0,0,0.1)' },
            pink: { img: 'bg/pink.jpg', gradient: 'linear-gradient(45deg, #ff9a9e, #fad0c4)', overlay: 'rgba(0,0,0,0.1)' },
            spongebob: { img: 'bg/spongebob.jpg', gradient: 'linear-gradient(180deg, #00a8ff, #fffbe0)', overlay: 'rgba(0,0,0,0.1)' },
            zootopia: { img: 'bg/zootopia.jpg', gradient: 'linear-gradient(to right, #43e97b, #38f9d7)', overlay: 'rgba(0,0,0,0.2)' },
            shinchan: { img: 'bg/shinchan.jpg', gradient: 'linear-gradient(45deg, #ff5722, #ffeb3b)', overlay: 'rgba(0,0,0,0.2)' },
            dark: { img: 'bg/dark.jpg', gradient: 'linear-gradient(to bottom, #111, #222)', overlay: 'rgba(0,0,0,0.7)' }
        };

        const app = createApp({
            setup() {
                const apiBase = '/api';
                const isMobile = ref(window.innerWidth <= 768);
                const token = ref(localStorage.getItem('ng_token') || '');
                
                const isPrivateMode = ref(false); 
                const privateToken = ref(localStorage.getItem('ng_private_token') || '');
                
                // ã€æ ¸å¿ƒä¿®å¤ã€‘å¦‚æœ token å­˜åœ¨ï¼Œå°±ä¸æ˜¾ç¤ºç™»å½•æ¡†ï¼
                const loginDialog = ref(!token.value);
                const privateDialog = ref(false);
                const passwordInput = ref("");
                const privatePasswordInput = ref("");

                const authFetch = async (url, options = {}) => {
                    const headers = options.headers || {};
                    headers['x-token'] = isPrivateMode.value ? privateToken.value : token.value;
                    
                    const res = await fetch(url, { ...options, headers });
                    
                    if (res.status === 401) {
                        ElMessage.error("ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•");
                        if (!isPrivateMode.value) {
                            token.value = "";
                            localStorage.removeItem('ng_token');
                            loginDialog.value = true;
                        } else {
                            privateToken.value = "";
                            localStorage.removeItem('ng_private_token');
                            isPrivateMode.value = false;
                        }
                        throw new Error("Unauthorized");
                    }
                    if (res.status === 403) {
                        ElMessage.error("æƒé™ä¸è¶³");
                        throw new Error("Forbidden");
                    }
                    if (res.status === 400) {
                        const errData = await res.json();
                        ElMessage.error(errData.detail || "æ“ä½œå¤±è´¥");
                        throw new Error(errData.detail);
                    }
                    return res;
                };

                const currentPath = ref(""); 
                const tableData = ref([]);
                const loading = ref(false);
                const selection = ref([]);
                
                const doLogin = async () => {
                    try {
                        const res = await fetch('/login', {
                            method: 'POST', headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ password: passwordInput.value })
                        });
                        
                        if (!res.ok) {
                            const errData = await res.json();
                            throw new Error(errData.detail);
                        }
                        
                        const data = await res.json();
                        token.value = data.token;
                        localStorage.setItem('ng_token', data.token);
                        
                        loginDialog.value = false;
                        ElMessage.success("æ¬¢è¿å›æ¥");
                        loadFiles();
                    } catch(e) { ElMessage.error(e.message || "å¯†ç é”™è¯¯"); }
                };

                const enterPrivateMode = () => {
                    if (privateToken.value) {
                        isPrivateMode.value = true;
                        currentPath.value = "";
                        loadFiles();
                        ElMessage.success("è¿›å…¥éšç§ç©ºé—´");
                    } else {
                        privateDialog.value = true;
                    }
                };
                
                const doUnlockPrivate = async () => {
                    try {
                        const res = await fetch('/login_private', {
                            method: 'POST', headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ password: privatePasswordInput.value })
                        });
                        if (!res.ok) throw new Error();
                        const data = await res.json();
                        privateToken.value = data.token;
                        localStorage.setItem('ng_private_token', data.token);
                        
                        privateDialog.value = false;
                        privatePasswordInput.value = "";
                        isPrivateMode.value = true;
                        currentPath.value = "";
                        loadFiles();
                        ElMessage.success("è§£é”æˆåŠŸ");
                    } catch(e) { ElMessage.error("å¯†ç é”™è¯¯"); }
                };

                const exitPrivateMode = () => {
                    isPrivateMode.value = false;
                    currentPath.value = "";
                    loadFiles();
                    ElMessage.info("å·²è¿”å›å…¬å¼€ç©ºé—´");
                };

                const loadFiles = async () => {
                    // å¦‚æœ token ä¸ºç©ºï¼Œå¼¹çª—ç™»å½•
                    if (!token.value) { loginDialog.value = true; return; }
                    loading.value = true;
                    try {
                        const res = await authFetch('/list', {
                            method: 'POST', headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ path: currentPath.value, is_private: isPrivateMode.value })
                        });
                        const data = await res.json();
                        tableData.value = [...data.folders.map(f=>({...f,isDir:true})), ...data.files.map(f=>({...f,isDir:false}))];
                    } catch (e) {} finally { loading.value = false; }
                };

                const handleUpload = async (e) => {
                    const file = e.target.files[0]; if(!file) return;
                    try {
                        const res = await authFetch('/get_upload_url', {
                            method: 'POST', headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ filename: file.name, prefix: currentPath.value, is_private: isPrivateMode.value })
                        });
                        const { url } = await res.json();
                        await fetch(url, { method: 'PUT', body: file });
                        ElMessage.success("ä¸Šä¼ æˆåŠŸ"); setTimeout(loadFiles, 1000);
                    } catch(err) { console.error(err); ElMessage.error("ä¸Šä¼ å¤±è´¥"); } finally { e.target.value=''; }
                };

                const doCreateFolder = async () => {
                    if(!newFolderName.value) return;
                    await authFetch('/create_folder', {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ path: currentPath.value + newFolderName.value, is_private: isPrivateMode.value })
                    });
                    createFolderDialog.value=false; newFolderName.value=""; setTimeout(loadFiles,500);
                };

                const batchDelete = async () => {
                    try { await ElementPlus.ElMessageBox.confirm('ç¡®å®šåˆ é™¤?','æç¤º'); } catch(e){return;}
                    await authFetch('/delete', {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ paths: selection.value.map(i=>i.isDir?i.path:i.full_path), is_private: isPrivateMode.value })
                    });
                    setTimeout(loadFiles,500);
                };

                const navigate = (path) => { currentPath.value = path; loadFiles(); };
                const videoDialog = ref(false); const currentVideoUrl = ref(""); const createFolderDialog = ref(false); const newFolderName = ref("");
                const handleRowClick = (row) => row.isDir ? navigate(row.path) : (row.type==='video' ? (currentVideoUrl.value=row.url,videoDialog.value=true) : window.open(row.url));
                const handleThemeChange = (n) => {
                    const t = themeConfig[n]; document.documentElement.style.setProperty('--app-bg-url', `url('${t.img}')`);
                    document.documentElement.style.setProperty('--app-bg-fallback', t.gradient);
                    document.documentElement.style.setProperty('--app-content-overlay', t.overlay);
                    localStorage.setItem('ng_theme', n);
                };

                onMounted(() => {
                    window.addEventListener('resize', () => isMobile.value = window.innerWidth <= 768);
                    handleThemeChange(localStorage.getItem('ng_theme') || 'doraemon');
                    if (token.value) loadFiles();
                });

                return {
                    isMobile, isPrivateMode, loginDialog, privateDialog, passwordInput, privatePasswordInput,
                    doLogin, enterPrivateMode, doUnlockPrivate, exitPrivateMode,
                    tableData, loading, currentPath, navigate, handleRowClick,
                    videoDialog, currentVideoUrl, createFolderDialog, newFolderName,
                    triggerUpload: ()=>document.querySelector('input[type=file]').click(), handleUpload, doCreateFolder, batchDelete,
                    selection, handleSelectionChange: (v)=>selection.value=v, handleThemeChange,
                    breadcrumbs: computed(() => { 
                        if (!currentPath.value) return []; 
                        let acc = ""; return currentPath.value.split('/').filter(p=>p).map(p => { acc += p + "/"; return { name: p, path: acc }; }); 
                    }),
                    Folder, Document, Picture, VideoPlay, Upload, Download, FolderAdd, Delete, MagicStick, Lock, Unlock
                };
            }
        });
        for(const [k,v] of Object.entries(ElementPlusIconsVue)) app.component(k,v);
        app.use(ElementPlus);
        app.mount('#app');
    </script>
</body>
</html>
