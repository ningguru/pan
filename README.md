# NingGuru Cloud (Gift Edition) â˜ï¸

> ä¸“ä¸ºä¸ªäººå’Œå›¢é˜Ÿæ‰“é€ çš„é«˜æ€§èƒ½ç§æœ‰äº‘ç›˜ç³»ç»Ÿã€‚
> åŸºäº Docker + MinIO + FastAPI æ·±åº¦å®šåˆ¶ï¼Œæ”¯æŒå¤šä¸»é¢˜åˆ‡æ¢ã€S3 åè®®ç›´ä¼ ã€æŒä¹…åŒ–å…ç™»å½•ä¸å¼¹æ€§æ‰©å®¹ã€‚

## ğŸ“– ç›®å½•

- [âœ¨ æ ¸å¿ƒç‰¹æ€§](#-æ ¸å¿ƒç‰¹æ€§)
- [ğŸš€ å¿«é€Ÿéƒ¨ç½²](#-å¿«é€Ÿéƒ¨ç½²)
- [ğŸ—ï¸ æ¶æ„ä¸é…ç½®](#-æ¶æ„ä¸é…ç½®)
    - [æœåŠ¡ç«¯å£](#æœåŠ¡ç«¯å£)
    - [Nginx åå‘ä»£ç† (æ ¸å¿ƒé…ç½®)](#nginx-åå‘ä»£ç†-æ ¸å¿ƒé…ç½®)
- [ğŸ–¥ï¸ ä½¿ç”¨æŒ‡å—](#-ä½¿ç”¨æŒ‡å—)
    - [Web ç«¯åŠŸèƒ½](#web-ç«¯åŠŸèƒ½)
    - [MinIO æ§åˆ¶å°](#minio-æ§åˆ¶å°)
- [ğŸ“¸ é«˜çº§ç©æ³•ï¼šæ­å»ºç§æœ‰å›¾åºŠ](#-é«˜çº§ç©æ³•æ­å»ºç§æœ‰å›¾åºŠ)
- [âš™ï¸ è¿ç»´æŒ‡å—](#-è¿ç»´æŒ‡å—)

---

## âœ¨ æ ¸å¿ƒç‰¹æ€§

- **ğŸš€ æé€Ÿä¼ è¾“**ï¼šå‰ç«¯ç›´è¿ MinIO å­˜å‚¨ï¼Œå¤§æ–‡ä»¶ä¸Šä¼ è·‘æ»¡å¸¦å®½ï¼Œæ— ä¸­é—´å±‚æŸè€—ã€‚
- **ğŸ” åŒé‡é‰´æƒ**ï¼šä¸¥æ ¼åŒºåˆ† **å…¬å¼€ç©ºé—´** ä¸ **éšç§ç©ºé—´**ã€‚
    - **å…¬å¼€å¯†ç **ï¼šä»…å¯è®¿é—®å…¬å…±æ–‡ä»¶ï¼Œæ— æ³•è¿›å…¥éšç§åŒºåŸŸã€‚
    - **éšç§å¯†ç **ï¼šè§£é”éšç§˜æ–‡ä»¶ï¼Œäº«å—å®Œå…¨æƒé™ã€‚
- **ğŸ’¾ æŒä¹…åŒ–å…ç™»å½•**ï¼šå†…ç½®è½»é‡çº§ SQLite æ•°æ®åº“ï¼ŒToken æœ‰æ•ˆæœŸ 30 å¤©ï¼Œåˆ·æ–°é¡µé¢ä¸æ‰çº¿ï¼Œé‡å¯æœåŠ¡ä¸ä¸¢å¤±ç™»å½•çŠ¶æ€ã€‚
- **ğŸ¨ é­”æ³•ä¸»é¢˜**ï¼šå†…ç½®å“†å•¦Aæ¢¦ã€æµ·ç»µå®å®ã€ç–¯ç‹‚åŠ¨ç‰©åŸç­‰ 6 å¥—ç²¾ç¾ UIï¼Œæ”¯æŒä¸€é”®çƒ­åˆ‡æ¢ã€‚
- **ğŸ“± å…¨ç«¯é€‚é…**ï¼šå“åº”å¼è®¾è®¡ï¼Œå®Œç¾é€‚é… PCã€å¹³æ¿ä¸æ‰‹æœºç«¯ã€‚
- **ğŸ’¾ å¼¹æ€§å­˜å‚¨**ï¼šæ”¯æŒå¤šç¡¬ç›˜æŒ‚è½½ï¼Œè‡ªåŠ¨è¯†åˆ«ç³»ç»Ÿæ•°æ®ç›˜è¿›è¡Œå®¹é‡èšåˆã€‚
- **ğŸ”Œ S3 å…¼å®¹**ï¼šåŸç”Ÿå…¼å®¹ AWS S3 åè®®ï¼Œå¯ä½œä¸º PicGo å›¾åºŠã€Rclone æŒ‚è½½ç›˜ä½¿ç”¨ã€‚

---

## ğŸš€ å¿«é€Ÿéƒ¨ç½²

æœ¬é¡¹ç›®é›†æˆäº†è‡ªåŠ¨åŒ–è¿ç»´è„šæœ¬ï¼Œä¸€é”®å®Œæˆç¯å¢ƒæ£€æµ‹ä¸å®¹å™¨ç¼–æ’ã€‚

1. **è¿è¡Œéƒ¨ç½²è„šæœ¬**
   
   ```bash
   chmod +x deploy.sh
   ./deploy.sh

*è„šæœ¬ä¼šè‡ªåŠ¨æ‰«æ `/data\*` ç›®å½•ä¸‹çš„ç£ç›˜ï¼Œå¹¶ç”Ÿæˆ `docker-compose.yaml`ã€‚*

   2.**åˆå§‹åŒ–é…ç½®**

é¦–æ¬¡è¿è¡Œæ—¶ï¼Œè„šæœ¬ä¼šè¦æ±‚ä½ è®¾ç½®ï¼š

- **å…¨ç«™è®¿é—®å¯†ç **ï¼šç”¨äºå…¬å¼€è®¿é—®ã€‚
- **éšç§ç©ºé—´å¯†ç **ï¼šç”¨äºè§£é”éšè—å†…å®¹ã€‚

### ğŸ—ï¸ æ¶æ„ä¸é…ç½®

| **æœåŠ¡åç§°**      | **å®¹å™¨ç«¯å£** | **å®¿ä¸»æœºç«¯å£ (é»˜è®¤)** | **è¯´æ˜**               |
| ----------------- | ------------ | --------------------- | ---------------------- |
| **Frontend**      | 80           | `8080`                | Vue3 å‰ç«¯ç•Œé¢          |
| **Backend**       | 8000         | `8000`                | FastAPI åç«¯ + SQLite  |
| **MinIO API**     | 9000         | `9000`                | S3 æ•°æ®æ¥å£ (æ ¸å¿ƒå­˜å‚¨) |
| **MinIO Console** | 9001         | `9001`                | å­˜å‚¨ç®¡ç†åå°           |

### Nginx åå‘ä»£ç† (æ ¸å¿ƒé…ç½®)

ä¸ºäº†è§£å†³**æµè§ˆå™¨è·¨åŸŸ(CORS)** å’Œ **S3 ç­¾åä¸»æœºåä¸åŒ¹é…** çš„é—®é¢˜ï¼Œç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨ Nginx è¿›è¡Œåä»£ã€‚

**é…ç½®æ–‡ä»¶è·¯å¾„**: `/etc/nginx/conf.d/ningguru.conf`

```nginx
server {
    listen 80;
    server_name pan.ningguru.cc.cd;

    # å…è®¸å¤§æ–‡ä»¶ä¸Šä¼  (å…¨å±€ç”Ÿæ•ˆ)
    client_max_body_size 0;

    # --- 1. åç«¯ API è½¬å‘ ---
    # å°†ç™»å½•ã€åˆ—è¡¨ã€é‰´æƒç­‰è¯·æ±‚è½¬å‘ç»™ FastAPI åç«¯
    location ~ ^/(login|list|get_upload_url|auth|api|create_folder|delete) {
        proxy_pass [http://127.0.0.1:8000](http://127.0.0.1:8000);
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # --- 2. MinIO ä¸Šä¼ è½¬å‘ (å…³é”®ä¿®å¤) ---
    # è§£å†³ "SignatureDoesNotMatch" é—®é¢˜çš„æ ¸å¿ƒé…ç½®
    location /drive/ {
        proxy_pass [http://127.0.0.1:9000](http://127.0.0.1:9000);
        
        # ã€æ ¸å¿ƒã€‘å¼ºåˆ¶ä¿®æ”¹ Host ä¸º minio:9000
        # æ¬ºéª— MinIOï¼Œè®©å®ƒè®¤ä¸ºè¯·æ±‚æ¥è‡ªå†…ç½‘ï¼Œä»è€Œé€šè¿‡ç­¾åæ ¡éªŒ
        proxy_set_header Host minio:9000;
        
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_buffering off;
    }

    # --- 3. å‰ç«¯é¡µé¢è½¬å‘ ---
    location / {
        proxy_pass [http://127.0.0.1:8080](http://127.0.0.1:8080);
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```
é…ç½®å®Œæˆåï¼Œæ‰§è¡Œ `nginx -s reload` ç”Ÿæ•ˆã€‚

### ğŸ–¥ï¸ ä½¿ç”¨æŒ‡å—

### Web ç«¯åŠŸèƒ½

- **åœ°å€**: `http://pan.ningguru.cc.cd`
- **ç™»å½•é€»è¾‘**:
  - è¾“å…¥ **å…¬å¼€å¯†ç ** -> è¿›å…¥å…¬å…±æ–‡ä»¶åŒº (æ— æ³•æ“ä½œéšç§æ–‡ä»¶)ã€‚
  - ç‚¹å‡»å³ä¸Šè§’ "éšç§ç©ºé—´" -> è¾“å…¥ **éšç§å¯†ç ** -> è§£é”å…¨éƒ¨æƒé™ã€‚
- **æ–‡ä»¶æ“ä½œ**: æ”¯æŒæ‹–æ‹½ä¸Šä¼ ã€æ–°å»ºæ–‡ä»¶å¤¹ã€æ‰¹é‡åˆ é™¤ã€MP4 è§†é¢‘åœ¨çº¿æ’­æ”¾ã€‚
- **ä¸»é¢˜åˆ‡æ¢**: ç‚¹å‡»å³ä¸Šè§’â€œé­”æ³•æ£’â€å›¾æ ‡å³å¯åˆ‡æ¢èƒŒæ™¯é£æ ¼ã€‚

### MinIO æ§åˆ¶å°

- **åœ°å€**: `http://pan.ningguru.cc.cd:9001`
- **é»˜è®¤è´¦å·**: `ningguru` (æˆ–éƒ¨ç½²æ—¶è®¾ç½®çš„è´¦å·)
- **é»˜è®¤å¯†ç **: `12345678`
- **åŠŸèƒ½**: åº•å±‚æ–‡ä»¶ç®¡ç†ã€Bucket ç­–ç•¥é…ç½®ã€ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚

### ğŸ“¸ é«˜çº§ç©æ³•ï¼šæ­å»ºç§æœ‰å›¾åºŠ

åˆ©ç”¨ MinIO çš„ S3 å…¼å®¹æ€§ï¼Œä½ å¯ä»¥å°†å…¶ä½œä¸º Typora + PicGo çš„å›¾åºŠï¼Œå®ç°â€œæˆªå›¾å³ä¸Šä¼ â€ã€‚

1. **åˆ›å»ºå­˜å‚¨æ¡¶:** ç™»å½• MinIO æ§åˆ¶å° -> Buckets -> Create Bucket (ä¾‹å¦‚ `images`)ã€‚
2. **è®¾ç½®å…¬å¼€æƒé™:** ç‚¹å‡» Bucket -> Access Policy -> Set strictly to **Public**ã€‚
3. **è·å–å¯†é’¥:** ç‚¹å‡» Identity -> Users -> Create Access Keyã€‚
4. **é…ç½® PicGo (S3 æ’ä»¶)**:
   - **åº”ç”¨å¯†é’¥ID**: (å¡«å…¥ Access Key)
   - **åº”ç”¨å¯†é’¥**: (å¡«å…¥ Secret Key)
   - **æ¡¶å**: `images`
   - **æ–‡ä»¶è·¯å¾„**: `{year}/{month}/{filename}`
   - **è‡ªå®šä¹‰èŠ‚ç‚¹**: `http://pan.ningguru.cc.cd:9000` (**æ³¨æ„æ˜¯ 9000 ç«¯å£**)

## âš™ï¸ è¿ç»´æŒ‡å—

### 1. å­˜å‚¨æ¨ªå‘æ‰©å®¹

æœåŠ¡å™¨æ’äº†æ–°ç¡¬ç›˜ (å¦‚ `/data3`)ï¼Ÿ

1. ç¡®ä¿æ–°ç¡¬ç›˜å·²æŒ‚è½½ã€‚
2. é‡æ–°è¿è¡Œ `./deploy.sh`ã€‚
3. è„šæœ¬ä¼šè‡ªåŠ¨å‘ç°æ–°ç›˜ï¼Œé€‰æ‹© `all` å³å¯å°†æ–°ç›˜åŠ å…¥é›†ç¾¤ï¼Œå®¹é‡è‡ªåŠ¨å åŠ ã€‚

### 2. æ•°æ®åº“å¤‡ä»½

ç”¨æˆ·çš„ç™»å½• Token å’Œå¯†ç é…ç½®å­˜å‚¨åœ¨ SQLite æ•°æ®åº“ä¸­ã€‚ å»ºè®®å®šæœŸå¤‡ä»½ï¼š

```shell
docker cp ningguru-api:/app/ningguru.db ./backup_ningguru.db
```

### 3. æŸ¥çœ‹å®æ—¶æ—¥å¿—

æ’æŸ¥ç™»å½•æˆ–ä¸Šä¼ é—®é¢˜ï¼š

```bash
docker logs -f --tail 100 ningguru-api
```

